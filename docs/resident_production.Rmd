---
title: "Resident Production Model"
author: "Caliper Corporation"
date: "March 2, 2021"
output: 
  html_document:
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(dplyr.summarise.inform = FALSE)
options(scipen = 999)

library(MASS)
library(pscl)
library(tidyverse)
library(knitr)
library(kableExtra)
```

## Introduction

Zero-Inflated Negative Binomial Distribution:  
[https://stats.idre.ucla.edu/r/dae/zinb/](https://stats.idre.ucla.edu/r/dae/zinb/)

> Zero-inflated negative binomial regression is for modeling count variables with excessive zeros and it is usually for overdispersed count outcome variables. Furthermore, theory suggests that the excess zeros are generated by a separate process from the count values and that the excess zeros can be modeled independently.

```{r, include=FALSE}
hh_df <- read_csv("data/output/_PRIVATE/survey_processing/hh_processed.csv")
person_df <- read_csv("data/output/_PRIVATE/survey_processing/per_processed.csv")
trips_df <- read_csv("data/output/_PRIVATE/survey_processing/trips_processed.csv")
logsum <- read_csv("data/input/nhb/logsums.csv")
```

```{r aggregate trips}
# # Approach 1: use trip weights. Have non-integer counts of trips.
# aggregate_trips <- trips_df %>%
#   filter(tour_type != "H" & homebased == "HB") %>%
#   group_by(hhid, personid, trip_type) %>%
#   summarize(trips = sum(trip_weight_combined) / sum(hh_weight_combined)) %>%
#   pivot_wider(names_from = trip_type, values_from = trips) %>%
#   mutate(across(everything(), ~ifelse(is.na(.x), 0, .x)))

# Approach 2: use household weights and have integer counts of trips.
aggregate_trips <- trips_df %>%
  filter(tour_type != "H" & homebased == "HB") %>%
  group_by(hhid, personid, trip_type) %>%
  summarize(
    trips = n(),
    p_taz = first(p_taz)
  ) %>%
  pivot_wider(names_from = trip_type, values_from = trips) %>%
  mutate(across(everything(), ~ifelse(is.na(.x), 0, .x))) %>%
  ungroup()

est_tbl <- person_df %>%
  left_join(aggregate_trips %>% select(-hhid), by = "personid") %>%
  left_join(hh_df, by = "hhid") %>%
  mutate(across(N_HB_K12_All:W_HB_EK12_All, ~ifelse(is.na(.x), 0, .x))) %>%
  # feature creation
  mutate(
    weight = hh_weight_combined.x,
    oth_ppl = hhsize - 1,
    oth_wrkr = num_workers - is_worker,
    oth_senior = num_seniors - is_senior,
    oth_kids = num_children - is_child,
    N_HB_K12_All = as.integer(N_HB_K12_All)
  ) %>%
  left_join(
    logsum %>% select(TAZ, access = GeneralAccessibility_sov),
    by = c("p_taz" = "TAZ")
  ) %>%
  group_by(hhid) %>%
  mutate(access = ifelse(is.na(access), mean(access, na.rm = TRUE), access)) %>%
  ungroup() %>%
  mutate(access = ifelse(is.na(access), mean(access, na.rm = TRUE), access))
```

The chart below is a histogram of person trips observed in the Triangle survey.
The occasional odd number of trips is due to things like leaving the region
or having a trip leave home late in the evening and the return trip isn't until
the next day (and not in the survey).

```{r}
hist_tbl <- est_tbl %>%
  mutate(
    trips = select(., N_HB_K12_All:W_HB_EK12_All) %>% rowSums(na.rm = TRUE))

ggplot(hist_tbl, aes(x = trips)) +
  geom_histogram(bins = 15, fill = "blue") +
  labs(
    title = "Histogram of Person Trips",
    x = "Trips",
    y = "Count"
  ) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks = seq(0, 15, by = 1))
```


```{r, N_HB_K12_All}
formula <- N_HB_K12_All ~ is_child + is_worker + is_senior + num_vehicles + 
  hhsize + access
m0 <- glm(formula, family = poisson, data = est_tbl)
m1 <- glm.nb(
  formula,
  data = est_tbl
)
m2 <- zeroinfl(
  N_HB_K12_All ~ is_worker + is_senior + num_vehicles + hhsize + 
    access | is_child,
  data = est_tbl, dist = "negbin"#, weights = weight
)

# This suggests that the negative binomial is much better than the poisson
# pchisq(2 * (logLik(m1) - logLik(m0)), df = 1, lower.tail = FALSE)

# This shows that the zero-inflated neg binomial is better than the neg binomial
# vuong(m1, m2)

summary(m2)
cor(est_tbl$N_HB_K12_All, m2$fitted.values) ^ 2
```

