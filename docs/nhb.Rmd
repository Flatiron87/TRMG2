---
title: "Non-Homebased Trips"
author: "Caliper Corporation"
date: "2/2/2021"
output: 
  html_document:
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(dplyr.summarise.inform = FALSE)
options(scipen = 999)

library(tidyverse)
library(knitr)
library(kableExtra)
source("R/estimate_nhb.R")
```

## Introduction

*TODO: Add*

Modes:

- SOV
- HOV
- Auto Pay
- Transit
- Bike
- Walk

```{r, include = FALSE}
trips <- read_csv(
  "data/output/_PRIVATE/survey_processing/trips_processed.csv") %>%
  mutate(
    mode_simple2 = case_when(
      mode_simple2 == "bus" ~ "t",
      TRUE ~ mode_simple2
    ),
    trip_type = paste0(trip_type, "_", mode_simple2)
  )

# hold all model tables in a list
output_list <- list()
```

```{r}
make_table <- function(model) {
  model$tbl %>%
    arrange(estimated_as) %>%
    kable(digits = 3) %>%
    kable_styling()
}

# unique(trips$mode_simple2)
```

The regression models below all enforce an intercept of 0. This changes the
r-squared values interpretation and makes it less meaningful.

## Non-work types

### N_NH_K12_All

These are non-home-based trips with one trend end at school (K-12). This
includes children attending school and parents dropping off children at school.
The "All" means that this type does not separate short from long duration
activities.

#### SOV

```{r, N_NH_K12_All_sov}
type <- "N_NH_K12_All_sov"

# Collapse trip types
equiv <- list(
  "N_HB_OD_Long_sov" = "N_HB_OD_All_sov",
  "N_HB_OD_Short_sov" = "N_HB_OD_All_sov",
  "N_HB_OD_Long_hov" = "N_HB_OD_All_hov",
  "N_HB_OD_Short_hov" = "N_HB_OD_All_hov"
)

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_hov",
  "N_HB_K12_All_sov",
  "N_HB_OD_All_sov"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### HOV

```{r, N_NH_K12_All_hov}
type <- "N_NH_K12_All_hov"

# Collapse trip types
equiv <- NULL

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_hov",
  "N_HB_OD_Long_hov",
  "N_HB_OD_Short_hov",
  "N_HB_K12_All_school_bus"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Auto Pay

There was only one observed trip in this category, so no model was estimated.

```{r, N_NH_K12_All_auto_pay}
type <- "N_NH_K12_All_auto_pay"
#Only 1 record
n_records <- trips %>%
  filter(trip_type == type) %>%
  nrow()
```

#### Transit

There were only five trips observed in this category, so no model was estimated.

```{r, N_NH_K12_All_t}
type <- "N_NH_K12_All_t"
n_records <- trips %>%
  filter(trip_type == type) %>%
  nrow()
```

#### Walk

```{r, N_NH_K12_All_walk}
type <- "N_NH_K12_All_walk"

# Collapse trip types
equiv <- list(
  "N_HB_K12_All_sov" = "N_HB_K12_All_auto",
  "N_HB_K12_All_hov" = "N_HB_K12_All_auto"
)

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_auto",
  "N_HB_K12_All_school_bus",
  "N_HB_K12_All_walk",
  "N_HB_OD_Short_hov",
  "N_HB_OMED_All_hov",
  "N_HB_K12_All_bike",
  "N_HB_OD_Short_walk"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Bike

There was only one trip observed in this category, so no model was estimated.

```{r, N_NH_K12_All_bike}
type <- "N_NH_K12_All_bike"
n_records <- trips %>%
  filter(trip_type == type) %>%
  nrow()
```

### N_NH_OME_All

These non-home-based trips are those where neither end is a K12 school and at
least one end is an "OME" activity type. This includes the most common reasons
people spend money: shopping, dining, and maintenance activities. The "All"
means that this trip includes all activity durations.

#### SOV

```{r, N_NH_OME_All_sov}
type <- "N_NH_OME_All_sov"

# Collapse trip types
equiv <- list(
  "N_HB_OD_Long_hov" = "N_HB_OD_All_hov",
  "N_HB_OD_Short_hov" = "N_HB_OD_All_hov"
)

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_hov",
  "N_HB_K12_All_sov",
  "N_HB_OD_All_hov",
  "N_HB_OD_Long_sov",
  "N_HB_OD_Short_sov",
  "N_HB_OME_All_sov",
  "N_HB_OMED_All_sov"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### HOV

```{r, N_NH_OME_All_hov}
type <- "N_NH_OME_All_hov"

# Collapse trip types
equiv <- list(
  "N_HB_OD_Long_sov" = "N_HB_OD_All_sov",
  "N_HB_OD_Short_sov" = "N_HB_OD_All_sov"
)

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_hov",
  "N_HB_K12_All_sov",
  "N_HB_OD_All_sov",
  "N_HB_OD_Long_hov",
  "N_HB_OD_Short_hov",
  "N_HB_OME_All_hov",
  "N_HB_OME_All_sov",
  "N_HB_OMED_All_auto_pay",
  "N_HB_OMED_All_hov"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Auto Pay

```{r, N_NH_OME_All_auto_pay}
type <- "N_NH_OME_All_auto_pay"

# Collapse trip types
equiv <- NULL

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_OD_Long_auto_pay",
  "N_HB_OD_Short_auto_pay",
  "N_HB_OME_All_auto_pay",
  "N_HB_OMED_All_auto_pay"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Transit

```{r, N_NH_OME_All_t}
type <- "N_NH_OME_All_t"

# Collapse trip types
equiv <- NULL

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_t",
  "N_HB_OD_Long_t",
  "N_HB_OD_Short_t",
  "N_HB_OME_All_other",
  "N_HB_OME_All_t",
  "N_HB_OME_All_walk"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Walk

```{r, N_NH_OME_All_walk}
type <- "N_NH_OME_All_walk"

# Collapse trip types
equiv <- c(
  "N_HB_OME_All_auto_pay" = "N_HB_OME_All_auto_pay",
  "N_HB_OMED_All_auto_pay" = "N_HB_OME_All_auto_pay",
  "N_HB_OD_Long_auto_pay" = "N_HB_OME_All_auto_pay",
  "N_HB_OD_Long_hov" = "N_HB_OD_All_hov",
  "N_HB_OD_Short_hov" = "N_HB_OD_All_hov",
  "N_HB_OD_Short_t" = "N_HB_OD_All_t",
  "N_HB_OD_Long_t" = "N_HB_OD_All_t"
)

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_t",
  "N_HB_OD_All_hov",
  "N_HB_OD_All_t",
  "N_HB_OD_Long_walk",
  "N_HB_OD_Short_sov",
  "N_HB_OD_Short_walk",
  "N_HB_OME_All_auto_pay",
  "N_HB_OME_All_bike",
  "N_HB_OME_All_hov",
  "N_HB_OME_All_other",
  "N_HB_OME_All_sov",
  "N_HB_OME_All_t",
  "N_HB_OME_All_walk",
  "N_HB_OMED_All_hov",
  "N_HB_OMED_All_walk"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Bike

```{r, N_NH_OME_All_bike}
type <- "N_NH_OME_All_bike"

# Collapse trip types
equiv <- NULL

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_bike",
  "N_HB_OD_Long_bike",
  "N_HB_OD_Long_t",
  "N_HB_OD_Short_bike",
  "N_HB_OME_All_bike"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

### N_NH_O_All

These non-home-based trips are those where neither end is a K12 school or
a shopping/dining/maintenance activity (OME). The "All" means that this trip
includes all activity durations.

#### SOV

```{r, N_NH_O_All_sov}
type <- "N_NH_O_All_sov"

# Collapse trip types
equiv <- c(
  "N_HB_K12_All_hov" = "N_HB_K12_All_auto",
  "N_HB_K12_All_sov" = "N_HB_K12_All_auto",
  "N_HB_OD_Long_hov" = "N_HB_OD_All_hov",
  "N_HB_OD_Short_hov" = "N_HB_OD_All_hov",
  "N_HB_OD_Long_sov" = "N_HB_OD_All_sov",
  "N_HB_OD_Short_sov" = "N_HB_OD_All_sov",
  "N_HB_OMED_All_hov" = "N_HB_OME_All_hov",
  "N_HB_OME_All_hov" = "N_HB_OME_All_hov",
  "N_HB_OMED_All_sov" = "N_HB_OME_All_sov",
  "N_HB_OME_All_sov" = "N_HB_OME_All_sov"
)

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_K12_All_auto",
  "N_HB_OD_All_hov",
  "N_HB_OD_All_sov",
  "N_HB_OME_All_sov",
  "N_HB_OME_All_hov"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### HOV

```{r, N_NH_O_All_hov}
type <- "N_NH_O_All_hov"

# Collapse trip types
equiv <- c(
  "N_HB_K12_All_hov" = "N_HB_K12_All_auto",
  "N_HB_K12_All_sov" = "N_HB_K12_All_auto",
  "N_HB_OD_Long_hov" = "N_HB_OD_Long_auto",
  "N_HB_OD_Long_sov" = "N_HB_OD_Long_auto"
)

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_OD_Long_auto",
  "N_HB_OD_Short_hov",
  "N_HB_OME_All_hov",
  "N_HB_OD_Short_sov",
  "N_HB_K12_All_auto",
  "N_HB_OMED_All_hov",
  "N_HB_OME_All_sov"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Auto Pay

```{r, N_NH_O_All_auto_pay}
type <- "N_NH_O_All_auto_pay"

# Collapse trip types
equiv <- NULL

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_OD_Short_sov",
  "N_HB_OD_Long_auto_pay",
  "N_HB_OD_Short_hov",
  "N_HB_OD_Short_auto_pay"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Transit

```{r, N_NH_O_All_t}
type <- "N_NH_O_All_t"

# Collapse trip types
equiv <- NULL

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_OD_Long_t",
  "N_HB_OD_Short_t",
  "N_HB_OMED_All_t",
  "N_HB_K12_All_walk",
  "N_HB_OME_All_t",
  "N_HB_OD_Short_walk",
  "N_HB_OD_Short_sov"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Walk

```{r, N_NH_O_All_walk}
type <- "N_NH_O_All_walk"

# Collapse trip types
equiv <- c(
  "N_HB_OME_All_sov" = "N_HB_OD_OME_sov",
  "N_HB_OD_Short_sov" = "N_HB_OD_OME_sov"
)

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_OD_Short_hov",
  "N_HB_OD_OME_sov",
  "N_HB_OD_Short_walk",
  "N_HB_OME_All_walk",
  "N_HB_OD_Long_walk",
  "N_HB_OD_Short_t"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`

#### Bike

```{r, N_NH_O_All_bike}
type <- "N_NH_O_All_bike"

# Collapse trip types
equiv <- NULL

# Restrict dependent variables
dependent_vars <- c(
  "N_HB_OD_Long_bike",
  "N_HB_OD_Short_bike",
  "N_HB_OME_All_bike"
)

# model1 <- estimate_nhb(trips, type)
# model2 <- estimate_nhb(trips, type, equiv = equiv)
model3 <- estimate_nhb(trips, type, equiv = equiv, 
                       dependent_vars = dependent_vars)

output_list[type] <- list(model3$tbl)
make_table(model3)
```

Adjusted R0 Squared: `r model3$r_sq`


```{r write_output, eval=FALSE}
output_dir <- "data/output/nhb/"
for (i in 1:length(output_list)) {
  name <- names(output_list)[i]
  df <- output_list[[i]]
  write_csv(df, paste0(output_dir, name, ".csv"))
}
```

