---
title: "Roadway Assignment"
author: "Caliper Corporation"
date: "October 7, 2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE)
options(dplyr.summarise.inform = FALSE)
options(scipen = 999)

library(tidyverse)
library(knitr)
library(kableExtra)
```

## Introduction

For a more basic introduction to highway assignment, see the [Travel Forecasting
Resource](https://tfresource.org/topics/Network_assignment.html) page on the
topic. In short, roadway assignment is where the predicted trips and roadway
network are combined to predict volumes and travel times.

TRMG2 uses a static, multi-class assignment with the following basic vehicle classes:

- SOV: single occupancy vehicles
- HOV2: vehicles with two occupants
- HOV3+: vehicles with three or more occupants
- CV: commercial vehicles
- SUT: single-unit trucks
- MUT: multi-unit trucks

In addition, the classes are further segmented by value of time. This is done
to accurately capture toll road usage. Finally, vehicles are assigned separately
by time period. More details are provided in the sections below.

## Matrix creation

TRMG2 has models to predict demand for many markets including residents,
commercial vehicles, university students, external travelers, and more. The
output of these models is combined into a single trip matrix for each time
period. This is also when directional and occupancy factors are applied to
arrive at vehicle trip matrices in Origin-Destination format (click
[here](time_of_day.html#Directionality_factors) for resident factors).

During this process, special attention is paid to the "auto pay" mode (Uber,
Lyft, etc.). When converting person trips to vehicle trips, a person traveling
alone is a single vehicle trip. However, by definition, they have a driver,
which means they are eligible for any HOV lanes the region might construct
in the future. For this reason, a person traveling alone is added to the HOV2
matrix while a person traveling with one or more family members is added to HOV3+.

## Value of time

Once trips are collapsed into the primary vehicle classes, they are split into
different value of time categories. The procedure for doing this is borrowed
from the NC Statewide Model (**TODO: add link**). For residents, this
stratification is informed by the household incomes at the origin and
destination as well as by the length of the trip.

This procedure divides each class into five VOT categories, except SUT which is
divided into three. These are shown in the table below.

```{r}
tbl <- read_csv("../master/assignment/vot_params.csv")
tbl <- tbl[1:18, c("Name", "Value")]
tbl <- tbl %>%
  separate(Name, into = c("a", "b", "c"), fill = "right") %>%
  mutate(
    Name = ifelse(!is.na(c), paste(a, b), a),
    VOT = ifelse(is.na(c), b, c)
  ) %>%
  select(Name, VOT, Value) %>%
  pivot_wider(names_from = Name, values_from = Value) %>%
  mutate(VOT = gsub("vot", "", VOT)) %>%
  rename(
    `VOT Group` = VOT,
    `PK Auto` = `pk auto`,
    `OP Auto` = `op auto`,
    SUT = sut,
    MUT = mut
  ) 

tbl %>%
  kable() %>%
  kable_styling(full_width = FALSE)
```

Such a high number of classes significantly increases assignment run time. To
mitigate this, categories 1-3 for the auto classes are collapsed and use the
values from VOT group 2. This trade off is reasonable given that it is the
higher VOT categories that are most likely to consider toll facilities.


## Assignment parameters

Relevant assignment details are listed below:

- Algorithm: N-conjugate Frank-Wolfe
- VDF: BPR
- Relative Gap: .0001 (1e-4)
- Maximum Iterations: 500
