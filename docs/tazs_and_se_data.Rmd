---
title: "TAZs and SE Data"
author: "Caliper Corporation"
date: "12/8/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(dplyr.summarise.inform = FALSE)
options(scipen = 999)

library(tidyverse)
library(sf)
library(leaflet)
```

```{r}
taz_old <- sf::read_sf("data/input/tazs/tazs 2020-11-02.shp") %>%
  st_transform(crs = st_crs('+proj=longlat +datum=WGS84'))
taz_new <- sf::read_sf("data/input/tazs/tazs 2020-12-08.shp") %>%
  st_transform(crs = st_crs('+proj=longlat +datum=WGS84'))
```

- Did a review focused on large zones and universities
- Presented initial recommendations
- Incorporated feedback and made edits

```{r}
leaflet() %>%
  addPolygons(
    data = taz_new,
    weight = 1,
    fill = FALSE,
    color = "red"
  ) %>%
  addPolygons(
    data = taz_old,
    weight = 1,
    fill = FALSE
  ) #%>%
  # setView(-78.404481, 35.464345, zoom = 12)
```

## Network updates

- Updated master highway layer with new centroids and connectors.
  - re-exported to make sure node IDs matched TAZ IDs
  
## Socio-economic updates

### Allocation to split zones

- Place holder approach uses area to distribute se data into split zones

```{r}
se_data <- read_csv(
  "data/input/se_data/se_2016.csv",
  col_types = cols(
    .default = col_double(),
    County = col_character(),
    TRM_6.2_Fill = col_logical()
  )
)

# Remove outputs from old model
# remove_outputs <- se_data %>%
#   select(TAZ_NG:Retail)

calc_percents <- se_data %>%
  left_join(taz_new %>% st_drop_geometry(), by = c("TAZ_NG" = "ORIG_ID")) %>%
  group_by(TAZ_NG) %>%
  mutate(pct = AREA / sum(AREA)) %>%
  mutate(across(
    c(HH, HH_POP, Stud_GQ:Retail),
    ~round(.x * pct, 0)
  )) %>%
  mutate(
    TAZ_NG = ifelse(is.na(ID), TAZ_NG, ID),
    County = ifelse(County == "External", "External", "Internal")
  ) %>%
  select(
    TAZ = TAZ_NG, Type = County, HH:Retail, K12 = ENROLLMENT,
    ParkCostW = PrkCosW1, ParkCostO = PrkCosO1, ParkCostU = PrkCosU1, 
    ADT:PCTCVEE
  ) %>%
  arrange(TAZ)

# Throw error if total households are off by more than rounding error
hh_ratio = sum(calc_percents$HH, na.rm = TRUE) / 
  sum(se_data$HH, na.rm = TRUE)
if (abs(hh_ratio - 1) > .01) stop(
  "Disaggregation caused significant change in total households"
)
```

### Income

```{r load census data}
source("R/load_census_data.R")
shapes <- load_census_data()

acs_bg <- shapes$acs_bg
acs_tract <- shapes$acs_tract
dec_bg <- shapes$dec_bg

taz <- st_transform(taz_new, st_crs(acs_bg)) %>% st_make_valid()
```

```{r}
# regional median income
# source: https://data.census.gov/cedsci/table?q=median%20income&g=0500000US37063,37135,37183&tid=ACSST1Y2019.S1901&hidePreview=true
reg_med_inc <- 65317

centroids <- taz %>%
  st_point_on_surface() %>%
  st_join(acs_bg %>% select(inc_med)) %>%
  as.data.frame()
  
num_missing <- nrow(centroids %>% filter(is.na(inc_med)))
add_income <- taz %>%
  left_join(centroids %>% select(ID, inc_med), by = "ID") %>%
  mutate(inc_med = ifelse(is.na(inc_med), reg_med_inc, inc_med)) %>%
  rename(MEDIANINC = inc_med)
```

Due to the skewed nature of income distributions, median income is a better
approximation of the average than the mean. This information was appended to the
socio-economic (SE) data from the Census, but income information is only
available at the block group geography level. As a result, all TAZs within a
block group have the same median income. In addition, income measures were
suppressed by the Census for `r num_missing` block groups. For TAZs in these
block groups, the regional median income of `r paste0('$',formatC(reg_med_inc,
big.mark=',', format = 'd'))` was used.






```{r}
output <- calc_percents %>%
  left_join(
    add_income %>%
      select(ID, MEDIANINC) %>%
      st_drop_geometry(),
    by = c("TAZ" = "ID")
  ) %>%
  relocate(MEDIANINC, .before = MEANINC) %>%
  select(-MEANINC)
  
```


```{r}
if (1 == 0) {
  write_csv(
    output, "data/output/se_data/se_2016.csv",
    na = "0"
  )
}
```