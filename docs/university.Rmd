---
title: "University"
author: "Caliper Corporation"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
# renv::restore()

source("R/university_productions.R")
source("R/university_attractions.R")
#source("R/university_survey_TLD.R")
#source("R/university_survey_MC.R")

knitr::opts_chunk$set(echo = FALSE)
options(dplyr.summarise.inform = FALSE)
options(scipen = 999, digits = 3)
```

## Introduction  

The University Model simulatens the on- and off-campus travel of students of the Triangle Region's four large universities:  North Carolina State University (NCSU), The University of North Carolina at Chapel Hill (UNC), Duke University (Duke) and North Carolina Central University (NCCU). In 2016, the four universities had a combined enrollment of `r enrollment_total`, with `r enrollment_NCSU` students at NCSU, `r enrollment_UNC` at UNC, `r enrollment_Duke` at Duke and `r enrollment_NCCU` at NCCU.  

```{r enrollment,echo=FALSE}
enrollment_NCSU <- socioecon2_df %>% 
  filter(!is.na(StudGQ_NCSU),!is.na(StudOff_NCSU)) %>% 
  summarize(total=sum(StudGQ_NCSU,StudOff_NCSU)) %>% 
  pull(total)

enrollment_UNC <- socioecon2_df %>% 
  filter(!is.na(StudGQ_UNC),!is.na(StudOff_UNC)) %>% 
  summarize(total=sum(StudGQ_UNC,StudOff_UNC)) %>% 
  pull(total)

enrollment_Duke <- socioecon2_df %>% 
  filter(!is.na(StudGQ_DUKE),!is.na(StudOff_DUKE)) %>% 
  summarize(total=sum(StudGQ_DUKE,StudOff_DUKE)) %>%
  pull(total)

enrollment_NCCU <- socioecon2_df %>% 
  filter(!is.na(StudGQ_NCCU),!is.na(StudOff_NCCU)) %>% 
  summarize(total=sum(StudGQ_NCCU,StudOff_NCCU)) %>%
  pull(total)

enrollment_total <- enrollment_NCSU + enrollment_UNC + enrollment_Duke + enrollment_NCCU
```

On- and off-campus students are expected to have different travel behavior. On-campus students are expected to make more trips, with many of those trips expected to start and end on campus. On-campus students are more likely to be undergraduate students who are enrolled at the university full-time. Graduate students are more likely to reside off-campus.

The model design (TODO: link to design document) calls for the following trip purposes, each segmented by on-campus and off-campus students:

* Home-Based-Campus (UHC)  
*	Home-Based-Other (UHO)  
*	Campus-Based-Other (UCO)  
*	On-Campus (UC1)  
*	Inter-Campus (UCC)  
*	University student Other-Other (UOO)  

## Trip Generation  
The first step in the model development process is to create trip production and attraction models for the above trip purposes. This analysis is presented below and relies on two data sources: a 2014 survey of NC State students conducted by ITRE on behalf of the NC Department of Transportation and a 2012 survey of students attending universities in Virginia. We are therefore assuming that the travel behavior of students attending NC State is sufficiently representative of NC Central, Duke, and UNC students. 

### Productions

```{r survey_overview, echo = FALSE}
Respondents_On_campus <- surveyRespondents_ResidenceClass_df %>%
  group_by(On_campus) %>%
  filter(On_campus==1) %>%
  summarize (sum=sum(n)) %>%
  pull()
Respondents_Off_campus <- surveyRespondents_ResidenceClass_df %>%
  group_by(On_campus) %>%
  filter(On_campus==0) %>%
  summarize (sum=sum(n)) %>%
  pull()
Respondent_Off_Campus_Weighted <- SurveyRespondent_Residence_Weighted_df %>%
  filter(On_campus==0)%>%
  pull()  
Respondent_On_Campus_Weighted <- SurveyRespondent_Residence_Weighted_df %>%
  filter(On_campus==1)%>%
  pull()

Survey_Total_Weighted_Trips <- Trip_subset_df %>% 
  filter(!is.na(Weight)) %>% 
  summarize(sum(Weight))
```

We start with the NC State survey. After removing respondents who did not finish the survey and respondents with a mismatch of more than one between thire stated number of trips and the number of trips for which they provided a description, the total number of complete and valid samples consists of `r Respondents_On_campus` on-campus students and `r Respondents_Off_campus` and off-campus students. The breakdown by graduate and undergraduate students is presented in the table below. These respondents reported a combined `r nrow(Trip_subset_df)` trips.

```{r survey overview2,echo=FALSE}
surveyRespondents_ResidenceClass_df %>%
  mutate(On_campus = if_else(On_campus == 0, "Off-campus", "On-campus")) %>%
  mutate(Graduate = if_else(Graduate == 0, "Undergraduate", "Graduate")) %>%
  rename(`Home Location` = On_campus, `Class Status` = Graduate, Count = n) %>%
  mutate(Share = paste0(sprintf("%2.1f", 100.0 * Count / sum(Count)), "%")) %>%
  arrange(-Count) %>%
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE)
```

The NCSU  dataset includes person weights, which were developed by ITRE based on residence locations (on-campus vs. off-campus), credit hours (full-time vs. part-time) and class status (undergraduate vs. graduate).  A total of `r Respondent_On_Campus_Weighted` on_campus and `r Respondent_Off_Campus_Weighted` off-campus records were assigned a weight. Based on the survey, the NCSU student population made a total of `r Survey_Total_Weighted_Trips` trips in 2016.

The trip production rates developed based on the NCSU survey were verified using trip rates based on surveys of students from four universities in Virginia conducted in 2009 and repeated for two of the universities in 2010, as summarized in Khattak et al. (2012). The first round of surveys obtained a sample size of 2784. The sample size of the second round was 2596.

The NCSU survey data was used to develop trip production rates for on-campus and off-campus students for five of the model's trip purposes, as follows.  

* Home-Based-Campus (UHC): P = Home  
* Home-Based-Other (UHO): P = Home  
* Campus-Based-Other(UCO): P = Campus  
* On-Campus (UC1): P = Campus  
* University student Other-Other (UOO): P = Origin 
* Campus to Campus (UCC): P = Origin

As noted above, the production end of the trip is either home, campus, or the trip origin, depending on the trip purpose. 

Figure 1 shows the average number of trips per student per day for each of the five trip purposes for students residing on-campus and off-campus, based on the raw NCSU survey data. The distribution is skewed to the right, with most students making few trips and a few students making many trips. There appears to be more variability in the number of trips reported by on-campus students, especially for the On-campus and Home-based Campus purposes, which, for on-campus students, both start and end on campus. 

```{r histogram,echo=FALSE}
purpose_map_df <- tibble(code = c("UHC", "UHO", "UCO", "UC1", "UOO", "UCC"),
                         name = c("Home-Campus",
                                  "Home-Other",
                                  "Campus-Other",
                                  "On-campus",
                                  "Other-to-other",
                                  "Campus-to-campus"))

Triprates_histogram <- Productions_bymode_df %>% 
  left_join(., purpose_map_df, by = c("Trip_Purpose" = "code")) %>%
  mutate(On_campus = if_else(On_campus == 0, "Off-campus", "On-campus")) %>%
  group_by(Person_ID,
           name, 
           On_campus) %>%
  summarize(`Trips per Student` = sum(Trips), .groups = "drop") %>%
  rename(`Trip Purpose` = name) %>%
  group_by(On_campus) %>%
  ggplot(aes(`Trips per Student`, fill = `Trip Purpose`)) + 
  geom_histogram(bins=20) + 
  facet_grid(`Trip Purpose` ~ On_campus)

Triprates_histogram + labs(title = "Figure 1 - Trips per student by Purpose by Home Location", 
                           caption = ("Source: NCSU survey (unweighted)"))
```

To develop production rates, two methods were explored/discussed: cross-classification and regression. Explanatory variables in regression models could include student characteristics such as class status (undergraduate and graduate), on and/or off-campus employment, credit hours (full-time or part-time), and car availability. These variables were expected, and/or shown by other research, to affect university trip production rates. However, using these variables would require that forecast year socio-economic datasets and/or upstream model steps included these variables, which is not currently expected. We therefore used cross-classification techniques, as discussed below.

As part of the cross-classification approach, daily trips per student reported in the NCSU survey were classified based on the following criteria:  
1) Place of residence: on-campus or off-campus  
2) Trip purpose: UHC, UHO, UCO, UC1 or UOO   
3) Travel mode: walk, bike, bus (includes public bus and shuttle), drive, carpool and other  

Production rates were developed based on the weighted and unweighted data, as a check on the influnce of the weighting. We found that the rates based on the weighted data are very similar to the rates based on the unweighted data.  

The average daily trip rate, using the weighted data, is `r w_avg_trips_df[,"avg_trips"]`.  On-campus students make an average of `r w_avg_trips_byresidence_df[2,"avg_trips"]` trips per day, while off-campus students make an average of `r w_avg_trips_byresidence_df[1,"avg_trips"]` trips per day. Rates by trip purpose show that on-campus students make more on-campus trips than off-campus students but make fewer off-campus trips.

Consistent with our findings, Khattak et al (2012) found that students in Virginia who reside on-campus make more trips (especially on-campus trips) than those who reside off-campus. On-campus students and that they walk more and drive less than off-campus students. The estimated production trip rates are somewhat lower than the production rates selected for the Triangle Model. During first round of surveys at Old Dominion (ODU), Virginia Tech (VT), University of Virginia and Virginia Commonwealth, daily trip rates ranged from 4.4 to 4.9.  For the second round of surveys, the survey instruments were revised to reduce the survey response burden and a larger sample size was obtained. Based on the second round, daily trip rates were 5.3 at ODU and 5.6 at VT. 

```{r,echo=FALSE}
purpose_map_df <- tibble(code = c("UHC", "UHO", "UCO", "UC1", "UOO", "UCC"),
                         name = c("Home-Campus",
                                  "Home-Other",
                                  "Campus-Other",
                                  "On-campus",
                                  "Other-to-other",
                                  "Campus-to-campus"))

P_rates_df %>%
  left_join(., purpose_map_df, by = c("Trip_Purpose" = "code")) %>%
  mutate(segment = str_replace(segment, " Students", "")) %>%
  mutate(segment = str_replace(segment, "_", "-")) %>%
  select(`Home Location` = segment, `Trip Purpose` = name, `Production Rate`, `Sample Size`) %>%
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE)
```

The trip production rates by mode will be used to estimate productions for Other-to-other trips. More specifically, the Other-to-other productions will be a function of Home-based Other and Campus-to-Other attractions, as discussed in the model design document. This approach ensures consistency between the "Other" trip ends by mode, i.e., it is not possible to have only automobile Home-based Other and Campus-to-Other movements and only bicycle Other-to-other movements. The table below summarizes the Other-to-other trips by mode. The production rates for the Other-to-other trips, segmented by automobile and non-automobile, are `r P_rates_ratioUOOtoUHOUCO_df$cartrips_ratioUOOtoUHOUCO` and `r P_rates_ratioUOOtoUHOUCO_df$non_cartrips_ratioUOOtoUHOUCO`. The small sample sizes prevent further segmentation by mode.   

```{r test, echo=FALSE}
avg_trips_UOO_df %>%
  mutate(segment = str_replace(segment, " Students", "")) %>%
  mutate(segment = str_replace(segment, "_", "-")) %>%
  select(`Home Location` = segment, Mode = Primary_Mode, Trips = trips, `Trip Rate` = avg_trips) %>%
  arrange(-Trips) %>%
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE)
```

A summary of the productions across universities is presented in the table below.
```{r}
Summary_Productions_df %>%
  separate(., Segments, into = c("remove", "code", "home", "remove_2", "school"), sep = "_", remove = TRUE) %>%
  mutate(`Home Location` = if_else(home == "On", "On-campus", "Off-campus")) %>%
  left_join(., purpose_map_df, by = c("code")) %>%
  select(`Home Location`, Purpose = name, University = school, Productions) %>%
  pivot_wider(., id_cols = c(`Home Location`, Purpose), names_from = University, values_from = Productions) %>%
  kable(digits = 0) %>%
  kable_styling(full_width = FALSE)
```


###  Trip Attraction

As with the trip production rates, trip attraction rates for off-campus attractions (Home-based Other and Campus-based Other) were developed based on the survey of NCSU students. For Home-based Other trips by off-campus students, both trips ends are off-campus. The number of trip attractions is estimated as a function of the land use of the zone.  For Campus-to-Other trips and for Home-based Other trips by on-campus students, the production end is the campus. Therefore, in addition to land use variables of the attraction zone, the attraction model for these segments also considers distance between the zone and campus, i.e., attractions very far from the NC State campus will not be visited by students.

For on-campus attractions (Home-based Campus, Campus-to-campus), the attractions are distributed among campus zones proportional to the distribution of the square footage of university buildings. 

THe analysis begins with torrelations between the university attractions and land use characteristics at the TAZ level. For trip attractions by on-campus students, the  off-campus student population and the number of retail jobs have the highest correlation coefficients. For trips by off-campus students, off-campus student population has the highest correlation coefficient.  
```{r correlations,echo=FALSE}
correlations_df %>% 
  filter(str_count(term, "Campus") == 0) %>%
  filter(term != "AllStudents_Trips") %>%
  arrange(-OnCampusStudents_Trips) %>%
  select(`TAZ Data Variable` = term, `On Campus Attr.` = OnCampusStudents_Trips, `Off Campus Attr.` = OffCampusStudents_Trips) %>%
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE)

```

#### Regression Models
The regression models were estimated for each purpose using a dataset that includes all TAZs for which the survey included trip attractions, of any purpose.  The TAZs that do nothave any trip attractions in the survey were excluded from the dataset used for model estimation.
```{r print function, echo=FALSE}
print_model <- function(model) {
  df <- tibble(variable = colnames(model$model),
               estimate = model$coefficients,
               statistic = coef(summary(model))[, "t value"],
               p.value = coef(summary(model))[, "Pr(>|t|)"]) %>%
    mutate(variable = if_else(str_count(variable, "Campus") > 0, "_intercept_", variable)) %>%
    arrange(variable) %>%
    bind_rows(., tibble(variable = c("Adjusted R-squared"),
                        estimate = summary(model)$adj.r.squared,
                        statistic = as.double(NA),
                        p.value = as.double(NA))) %>%
    kable(digits = 4) %>%
    kable_styling(full_width = FALSE)
  
  return(df)
  
}
```

The  model explains the number of trip attractions at the TAZ level based on the number of the students residing in the TAZ and the number of retail jobs in the TAZ. The coefficients have the expected signs. 

##### On-campus, Campus-Other
```{r, echo=FALSE}
print_model(Model_OnCampusUCO_2)

```

As Campus-other trips by on-campus students, Home-based Other trips by on-campus students are trips between the campus and off-campus location. The model explains the number of trips based on the number of off-campus students residing in the TAZ, the number of retail jobs and the distance to campus. The distance is calculated as the average of the distances between the centroid of the TAZ  and each of the centroids of the different NCSU campus TAZs.  All coefficients have the expected sign. As expected, trip attractions decrease as the distance increases and trip attractions increase as student population and retail jobs increase. 

##### On-campus, Home-based other
```{r,echo=FALSE}
print_model(Model_Oncampus_UHO_2)
```

As UCO and UHO trips by on-campus students, UCO trips by off-campus students are trips between the campus and off-campus location. The model explains UCO trips by off-campus students based on distance to campus, off-campus student population and  number of retail jobs.

##### Off-campus, Campus-based other
```{r,echo=FALSE}
print_model(Model_Offcampus_UCO_2)
```

[START HERE]

#####  UHO Trips by Off-campus students  
UHO trips by off-campus students have two off-campus trip ends. The model explains UHO trips by off-campus students based on the off- campus student population and the number of retail jobs.
```{r, echo=FALSE}
print_model(Model_Offcampus_UHO_2)


```
## TRIP DISTRIBUTION  
### Trip length distribution from the NCSU survey
```{r,echo=FALSE}
zonetozonedistance_bypurpose_histogram + labs(title = "Trip Length Distribution (All purposes,except UC1)", 
                                              subtitle="for off-campus students (On_campus== 0) and on-campus students (On_campus == 1) students", 
                                              caption = ("Source: NCSU survey (unweighted)"))


zonetozonedistance_UC1_histogram + labs(title = "Trip Length Distribution (UC1 Trips)", 
                                        subtitle="for off-campus students (On_campus== 0) and on-campus students (On_campus == 1) students", 
                                        caption = ("Source: NCSU survey (unweighted)"))
```

## MODE CHOICE
### Mode split from NCSU survey
Based on the NCSU survey, the majority of the trips by on-campus students are walk trips.  The mode split graph below shows that when segmenting by trip purpose, the survey dataset includes less than 20 trips (horizontal black line) for some of mode-purpose combinations. The graph does not show UC1 trips which are mostly walk trips.
#### Sample overview
```{r oncampus_modetrips, echo = FALSE}
trips_bypurpose_oncampus_plot + labs(title = "Mode Split by Purpose (except UC1)", 
                                     subtitle="On-campus students", 
                                     caption = ("Source: NCSU survey (unweighted)"))
```
Based on the NCSU survey,the majority of the trips by off-campus students that are not within the campus(UC1) are car trips.  The mode split graph below shows that when segmenting by trip purpose, the survey dataset includes less than 20 trips (horizontal black line) for some of mode-purpose combinations. The graph does not show UC1 trips, which are mostly walk trips.
```{r}
trips_bypurpose_offcampus_plot + labs(title = "Mode Split by Purpose (except UC1)", 
                                     subtitle="Off-campus students", 
                                     caption = ("Source: NCSU survey (unweighted)"))

```
#### On-campus students mode split
```{r,echo=FALSE}
modesplit_bypurpose_oncampus_2_df %>% 
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE)
```

#### Off-campus students mode split
```{r,echo=FALSE}
modesplit_bypurpose_offcampus_2_df %>% 
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE)
```

### Mode split calibration targets
#### On-campus students mode split calibration targets
```{r,echo=FALSE}
calibrationtargets_bypurpose_oncampus_df %>% 
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE)
```

#### Off-campus students mode split calibration targets
```{r,echo=FALSE}
calibrationtargets_bypurpose_offcampus_df %>% 
  kable(digits = 3) %>%
  kable_styling(full_width = FALSE)
```

