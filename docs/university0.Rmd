---
title: "University"
author: "name"
date: "5/12/2021"
output: html_document
---

```{r setup, include=FALSE}
#source("R/university_preparedata.R")
#source("R/university_skims.R")
source("R/university_productions.R")
source("R/university_attractions.R")
#source("R/university_distribution.R")
#source("R/university_modechoice.R")

knitr::opts_chunk$set(echo = FALSE)
options(dplyr.summarise.inform = FALSE)
options(scipen = 999)
```

## Introduction  

The University Model captures the on- and off-campus travel behavior of students of the Triangle Region's four main universities:  North Carolina State University (NCSU), The University of North Carolina at Chapel Hill (UNC), Duke University (Duke) and North Carolina Central University (NCCU). In 2016, the four universities had a combined enrollment of `r enrollment_total`, with `r enrollment_NCSU` students at NCSU, `r enrollment_UNC` at UNC, `r enrollment_Duke` at Duke and `r enrollment_NCCU` at NCCU. 

On- and off-campus students are expected to have different travel behavior. On-campus students are expected to make more trips and most of those trips are expected to start and end on campus. On-campus students are more likely to be undergraduate students who are enrolled at the university full-time while graduate students are more likely to reside off-campus.The model is segmented by on-campus and off-campus student and by the following trip purposes:  
* Home-Based-Campus (UHC)  
*	Home-Based-Other (UHO)  
*	Campus-Based-Other (UCO)  
*	On-Campus (UC1)  
*	Inter-Campus (UCC)  
*	University student Other-Other (UOO)  

## TRIP GENERATION  

### TRIP PRODUCTION RATES  

#### Sources  

##### 2014 NCSU Survey  
The trip production rates were developed based on a survey of NCSU students conducted by the Institute for Transportation Research and Education (ITRE) for the North Carolina Department of Transportation (NCDOT) in 2014. [description of survey and link to the survey report].  
After removing respondents who did not finish the survey and respondents with a mismatch of more than 1 between the stated number of trips and the number of trips for which they provided a description, the total number of complete and valid samples is as follows:  
*On-Campus students: `r survey_desc1[[2,2]]`, of which `r survey_desc2[[3,3]]` undergraduates and `r survey_desc2[[4,3]]` graduates  
*Off-Campus students:`r survey_desc1[[1,2]]`, of which `r survey_desc2[[1,3]]` undergraduates and `r survey_desc2[[2,3]]` graduates  

The NCSU survey dataset includes person weights which were developed by ITRE based on residence locations (on-campus vs. off-campus), credit hours (full-time vs. part-time) and class status (undergraduate vs. graduate).  A total of `r weighted_records[[2,2]]` on_campus and `r weighted_records[[1,2]]` off-campus records were assigned a weight.  

##### 2012 Virginia Surveys   
The trip production rates developed based on the NCSU survey were verified using trip rates based on surveys of students from 4 universities in Virginia, as summarized in Khattak et al. (2012). [link to the report and finding][describe survey administration and survey methods]

#### Segmentation   

The NCSU survey data was used to develop trip production rates for on-campus and off-campus students for 5 of the model's trip purposes. 
*Home-Based-Campus (UHC): P = Home  
*Home-Based-Other (UHO): P = Home  
*Campus-Based-Other(UCO): P = Campus  
*On-Campus (UC1): P = Campus  
*University student Other-Other (UOO): P = Origin  

The NCSU survey data set included only `r nrow(UCC)` Inter-Campus (UCC) trips, which is the model's 6th trip purpose. Two of the trips are classified as UHO. The other two trips are UHC trips by a NCSU graduate student who resides on the UNC campus.

#### Exploratory Analysis 

Figure 1 shows the average number of trips per student per day for each of the 5 trip purposes for students residing on-campus and off-campus, based on the raw NCSU survey data.  Figure 2 presents the same information based on weighted data.
*The distribution is skewed to the right, with most students making few trips and a few students making many trips per day.  
*There appears to be more variability in the number of trips reported by on-campus students, especially in UC1 and UCH, which are trips that both start and end on campus for on-campus students.  Applying the weights reduces the variability in UCH trips.


```{r,echo=FALSE}
Triprates_histogram<-Productions_df %>% 
  group_by(Person_ID,
           Trip_Purpose, 
           On_campus)%>%
  summarize(Trips_per_student=sum(Trips),.groups = "drop")%>%
  group_by(On_campus) %>% 
  ggplot(aes(Trips_per_student, fill=Trip_Purpose)) + 
  geom_histogram(bins=20) + 
  facet_grid(Trip_Purpose~On_campus)

Triprates_histogram + labs(title = "Figure 1 - Trips per student by purpose", 
                          subtitle="for off-campus (On_campus==0) and on-campus (On_campus==1) students", 
                          caption = ("Source: NCSU survey (unweighted)"))
###problem with y-axis
W_Triprates_histogram<-Productions_df %>%   
  group_by(Person_ID,
           Trip_Purpose, 
           On_campus)%>%
  summarize(W_Trips_per_student=sum(Trips_Weighted)/sum(Weight),.groups = "drop")%>%
  group_by(On_campus) %>% 
  ggplot(aes(W_Trips_per_student, fill=Trip_Purpose)) + 
  geom_histogram(aes(y = stat(density)), bins=20) + 
  facet_grid(Trip_Purpose~On_campus)

W_Triprates_histogram + labs(title = "Figure 2 - Trips per student by purpose", 
                          subtitle="for off-campus (On_campus==0) and on-campus (On_campus==1) students", 
                          caption = ("Source: NCSU survey (weighted)"))
```

To develop production rates, two methods were explored: cross-classification and regression.

#### Cross-classification  

As part of the cross-classification approach, daily trips per student reported in the NCSU survey were classified based on the following criteria:
1) place of residence: on-campus or off-campus
2) trip purpose: UHC, UHO, UCO, UC1 or UOO 
3) mode: walk, bike, bus (includes public bus and shuttle), drive, carpool and other

Production rates were developed based on raw data and based on weighted data. The rates based on the weighted data are very similar to the rates based on the raw data. 

Based on the weighted data, the average daily trips rate is `r avg_trips[[1,1]]`.  On-campus students make an average of `r avg_trips_byres[[2,2]]` trips per day while off- campus students make an average of `r avg_trips_byres[[1,2]]` trips per day. Rates by trip purpose show that on-campus students make more on-campus trips than off-campus students but make fewer off-campus trips.



##### Trip Rates by Place of Residence and Trip Purpose  
```{r , echo=FALSE}
headers<-c("Segment","Trip Purpose","Trip Rate", "Segment Sample Size")
kable(avg_trips_bypurpose[,avg_trips_bypurpose_col],caption ="Trip Rates by Purpose",col.names=headers)
kable(w_avg_trips_bypurpose[,w_avg_trips_bypurpose_col],caption ="Weighted Trip Rates by Purpose",col.names = headers)

```

##### UOO Trip Rates by Mode  
Trip production rates by mode will be used to estimate a trip production rate for UOO trips based on the relationship between trip production by mode for UOO trips and for UHO and UCO trips.  SCOPE: "The UOO trips should be generated separately by mode as a function of (or rate per) UHO and UCO off-campus trip ends by mode and optionally a nearby accessibility variable (provided by Caliper).  UOO trip generation and distribution models will therefore be implemented to run at the end of the university model after the other trip purposes"
```{r}
avg_trips_UHOUCOUOO<-rbind(avg_trips_UHOUCO,avg_trips_UOO)
avg_trips_UOO_col=c(2,1,5,6,4)
headers<-c("Segment","Mode","Trip Rate", "Respondents", "Segment Sample Size")
kable(avg_trips_UHOUCOUOO[,avg_trips_UOO_col],caption ="Trip Rates by Mode",col.names=headers)
```

#### Regression  

As an alternative to the cross-classification method, trip production rates by trip purpose were developed using regression models. The dependent variable is the number of trips per student per day. Potential explanatory variables are place of residence (on-, off- or near campus), graduate or undergrad, full-time or part-time enrollment, employment status and on- or off-campus employment location. 

A number of models were developed for different trip purpose/residential location combinations and for all data combined, using dummy variables for trip purpose and residential location, with the weighted survey data. Because the trip data are counts and the distribution is skewed, a Poisson regression model was used. A Poisson regression is a generalized linear model used to model count data. In the two models presented below, most of the coefficients are significant and have the expected sign.  

#####  Overview of Models

######  Model_a
Model_a explains the number of trips per student based on residential location (on-campus and off-campus), class status (undergraduate and graduate) and includes dummy variables for 4 of the 5 trip purposes. All coefficients are significant. As expected, the model shows that on-campus students tend to make more trips than off-campus students and that graduate students tend to make fewer trips than undergraduate students. The model shows that all trip purposes, with the exception of UCO trips are more likely than UOO trips, while the cross-classification showed that UOO is the least likely trip purpose.
```{r}
summary(All_P_modela)
```


######  Model_b  
Model_b includes a separate model for each trip purpose. The models explain the number of trips based on residential location (on-campus and off-campus), class status (undergraduate and graduate).  All the models have significant coefficients except the UOO model and the graduate coefficient of the UC1 model. As the combined trip purpose model, the UCO and the UHC models show that on-campus students tend to make more trips and that graduate students tend to make fewer trips. The UHO model shows that on-campus students tend to make fewer UHO trips than off-campus students.
```{r}
ByPurpose_P_modelb
```

##### Estimate Trip Production Rates  

Model_a was used to develop example trip production rates. 
```{r}
Production_rates_frommodel<-data.frame(Segment=Segments,Trip_Rate=Results)
Production_rates_frommodel
```

##### Conclusion Trip Production

Compare rates based on cross classification based on rates based on regression - higher based on regression
Select cross classification rates
*Comparison to Khattak et al () During first round of surveys at ODU, VT, UVA and VCU, daily trip rates ranged from 4.4 to 4.9.  During the second round of surveys, daily trip rates were 5.3 at ODU and 5.6 at VT.[add other sources]. Consistent with the NCSU survey findings, Khattak found that students who reside on-campus make more trips than those who reside off-campus.

```{r}
w_avg_trips_bypurpose


```

Trip productions by TAZ were estimated by applying the trip production rates as follows :
On-Campus Students:  
* UC1 Productions = Share of campus buildings in TAZ * enrollment *  UC1 On-campus production rate
* UCO Productions= Share of campus buildings in TAZ * enrollment *  UCO On-campus production rate
* UHC Productions = Number of students in student group quarters in *   UHC On-campus production rate
* UHO Productions = Number of students in student group quarters *   UHO On-campus production rate

Off-Campus Students:  
* UC1 Productions = Share of campus buildings in TAZ * enrollment *  UC1 Off-campus production rate
* UCO Productions= Share of campus buildings in TAZ * enrollment *  UCO Off-campus production rate
* UHC Productions = Number of students in off-campus housing  *   UHC Off-campus production rate
* UHO Productions = Number of students in off-campus housing *   UHO Off-campus production rate


```{r}
t(Summary_Productions_df)
```


Off-Campus Students:
###  TRIP ATTRACTION RATES 

#### Source

As the trip production rates, trip attraction rates for off-campus attractions (UHO and UCO) were developed based on a survey of NCSU students conducted by ITRE for NCDOT in 2014. For UHO trips by off-campus students, both trips ends are off-campus. The number of trip attractions is estimated as a function of the land use of the zone.  For UCO trips and for UHO trips by on-campus students, the production end is the campus. Therefore, in addition to land use variables of the attraction zone, the attraction model for these segments also considers distance between the zone and campus.
For on-campus attractions (UHC,UC1), the attractions are distributed among campus zones proportional to the distribution of the building square feet. 

#### Exploratory Analysis  

##### Correlations  
```{r}
correlations_df
```



#### Regression Models

##### UCO trips by On-campus students
6 models

```{r}
# Regression models - Production On-campus & Attraction Off-campus-----------------------------------------------------------

summary(lm_modelOn_UCOTrips_1)
```


```{r}

summary(glm_modelOn_UCOTrips_1)
```


```{r}
summary(glm_modelOn_UCOTrips_3)
```


```{r}
summary(glm_modelOn_UCOTrips_4)
```

selected
```{r}
summary(glm_modelOn_UCOTrips_5)
```


```{r}
summary(glm_modelOn_UCOTrips_6)
```

##### UHO trips by On-campus students
3 models
```{r}

summary(glm_modelOn_UHOTrips_4)
```

selected
```{r}
summary(glm_modelOn_UHOTrips_5)
```


```{r}
summary(glm_modelOn_UHOTrips_6)
```

#####  UCO Trips by Off-campus students  
3 models?
```{r}

summary(glm_modelOff_UCOTrips_4)
```


```{r}

summary(glm_modelOff_UCOTrips_5)
```

Selected
```{r}

summary(glm_modelOff_UCOTrips_6)
```

#####  UHO Trips by Off-campus students
both trips ends are off-campus
```{r}
# Regression models - Production and Attraction Off-campus-----------------------------------------------------------
lm_modelOA_non_1 = lm(W_Off_UHOTrips ~ Total_POP , data = OA_from_non_campus_df)
summary(lm_modelOA_non_1)

glm_modelOA_non_1 = glm(W_Off_UHOTrips ~ Total_POP , family=poisson, data = OA_from_non_campus_df)
summary(glm_modelOA_non_1)

lm_modelOA_non_2 = lm(W_Off_UHOTrips ~ Total_POP + Retail , data = OA_from_non_campus_df)
summary(lm_modelOA_non_2)

glm_modelOA_non_2 = glm(W_Off_UHOTrips ~ Total_POP + Retail, family=poisson, data = OA_from_non_campus_df)
summary(glm_modelOA_non_2)

```


## TRIP DISTRIBUTION  

## MODE CHOICE  

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
