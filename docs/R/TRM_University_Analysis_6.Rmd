---
title: "R Notebook"
output: html_notebook
---
```{r, include = FALSE}
packages_vector <- c("tidyverse",
                     "corrr"
                   )
need_to_install <- packages_vector[!(packages_vector %in% installed.packages()[,"Package"])]
if (length(need_to_install)) install.packages(need_to_install)
for (package in packages_vector){
  library(package, character.only = TRUE)
}

```

```{r, echo=FALSE}
#working directory
#TRM<-"C:/Users/vamerlynck/Documents/TriangleTDM/data" #github repo
#setwd(TRM)

#processed data
Productions_df<- readRDS("Productions_df.RDS")
Attractions_df<-readRDS("Attractions_df.RDS")
Productions_forregression_df<-readRDS("Productions_forregression_df.RDS")
Attractions_byTAZ_df<-readRDS("Attractions_byTAZ_df.RDS")
Trip_subset_df<-readRDS("Trip_subset_df.RDS")
Person_subset_df<-readRDS("Person_subset_df.RDS")


```
# UNIVERSITY MODEL
The University Model captures the on- and off-campus travel behavior of students of the Triangle Region's four main universities:  North Carolina State University (NCSU), The University of North Carolina at Chapel Hill (UNC), Duke University (Duke) and North Carolina Central University (NCCU). In 2016, the four universities had a combined enrollment of x, with __ students at NCSU, __ at UNC, _ at Duke and __ at NCCU. [link to r]

On- and off-campus students are expected to have different travel behavior. On-campus students are more likely to be undergraduate students who are enrolled at the university full-time while graduate students are more likely to reside off-campus.The model is segmented by on-campus and off-campus student and by the following trip purposes:  
* Home-Based-Campus (UHC)  
*	Home-Based-Other (UHO)  
*	Campus-Based-Other (UCO)  
*	On-Campus (UC1)  
*	Inter-Campus (UCC)  
*	University student Other-Other (UOO)
 

```{echo=FALSE}
#{r remote-io}
input_dir <- "../data/input/"
output_dir<-"../data/output/"

#put script in docs/R


Productions_df<-readRDS(paste0(input_dir,"Productions_df.RDS"))
Attractions_df<-readRDS(paste0(input_dir,"Attractions_df.RDS"))
Trip_subset_df<-readRDS(paste0(input_dir,"Trip_subset_df.RDS"))
Person_subset_df<-readRDS(paste0(input_dir,"Person_subset_df.RDS"))
```


## TRIP GENERATION

###TRIP PRODUCTION RATES
The trip production rates were developed based on a survey of NCSU students conducted by the Institute for Transportation Research and Education (ITRE) for the North Carolina Department of Transportation (NCDOT) in 2014. [description of survey and link to the survey report].[Number on- and off-campus respondents, broken down by undergrad and grad]

The trip production rates developed based on the NCSU survey were verified using trip rates based on surveys of students from 4 universities in Virginia, as summarized in Khattak et al (). [link to the report and finding][survey administration and survey methods]

The NCSU survey data was used to develop trip production rates for on-campus and off-campus students for the  5 trip purposes. 

*Home-Based-Campus (UHC): P = Home  
*Home-Based-Other (UHO): P = Home  
*Campus-Based-Other(UCO): P = Campus  
*On-Campus (UC1): P = Campus  
*University student Other-Other (UOO): P = Origin  

The NCSU survey data set did not include any [double check] Inter-Campus (UCC) trips, which is the model's 6th trip purpose. 

#### Exploratory Analysis 
Figure 1 shows the average number of trips per student per day for each of the 5 trip purposes for students residing on-campus and off-campus, based on the raw NCSU survey data.  Figure 2 presents the same information based on weighted data.The person weights included in the NCSU survey were developed based on residence locations (on-campus vs. off-campus), credit hours (full-time vs. part-time) and class status (undergraduate vs. graduate).

*[change y axis to proportion to compare on and off campus]
*The distribution is skewed to the right, with most students making few trips and a few students making many trips per day.  
*There appears to be more variability in the number of trips reported by on-campus students, especially in UC1 and UCH, which are trips that both start and end on campus for on-campus students.  Applying the weights reduces the variability in UCH. 
```{r,echo=FALSE}
Triprates_histogram<-Productions_df %>% 
  group_by(Person_ID,
           Trip_Purpose, 
           On_campus)%>%
  summarize(Trips_per_student=sum(Trips))%>%
  group_by(On_campus) %>% 
  ggplot(aes(Trips_per_student, fill=Trip_Purpose)) + 
  geom_histogram() + 
  facet_grid(Trip_Purpose~On_campus)

Triprates_histogram + labs(title = "Figure 1 - Trips per student by purpose", 
                          subtitle="for off-campus (On_campus==0) and on-campus (On_campus==1) students", 
                          caption = ("Source: NCSU survey (unweighted)"))

W_Triprates_barchart<-Productions_df %>% # weighted trips 
  group_by(Person_ID,
           Trip_Purpose, 
           On_campus)%>%
  summarize(W_Trips_per_student=sum(Trips_Weighted)/sum(Weight))%>%
  group_by(On_campus) %>% 
  ggplot(aes(W_Trips_per_student, fill=Trip_Purpose)) + 
  geom_histogram() + 
  facet_grid(Trip_Purpose~On_campus)

W_Triprates_barchart + labs(title = "Figure 2 - Trips per student by purpose", 
                          subtitle="for off-campus (On_campus==0) and on-campus (On_campus==1) students", 
                          caption = ("Source: NCSU survey (weighted)"))


```


To develop production rates, two methods were explored: cross-classification and regression.

####Cross-classification
As part of the cross-classification approach, daily trips per student reported in the NCSU survey were classified based on the following criteria:
1) place of residence: on-campus or off-campus
2) trip purpose: UHC, UHO, UCO, UC1 or UOO 
3) mode: walk, bike, bus (includes public bus and shuttle) and car (includes drive and passenger)

Production rates were developed based on raw data and based on weighted data. The rates based on the weighted data are very similar to the rates based on the raw data. 

Based on the weighted data, on-campus students make an average of 9.75 trips per day while off- campus students make 12.88 trips per day. For on-campus students, the majority of the trips are trips within the campus: on-campus students make an average of 8 trips within the campus per day, including 5.37 UC1  and 2.40 UHC.  [add links to the values]


```{r,echo=FALSE}
#trip rates by purpose
TripProductionrates_base_df<-Productions_df %>% 
  group_by(Person_ID,
           Trip_Purpose,
           On_campus)%>%
  summarize(Total_Trips=sum(Trips))%>%
  group_by(On_campus,
           Trip_Purpose) %>% 
  summarize(segment="Trip_Rates (not weighted)",
            avg_trips=round(mean(Total_Trips),digits=2), 
            variance=round(var(Total_Trips),digits=2),
          persons=n())%>%
  select(Trip_Purpose,
         segment,
         persons,
         avg_trips)

TripProductionrates_base_df

# weighted trip rates - on campus
W_On_Campus_TripProductionrates_df<-Trip_subset_df %>%
  filter(On_campus ==1 
         & Trip_Purpose!="99" 
         & !is.na(Trip_Purpose) 
         & !is.na(Weight))%>%
  group_by(On_campus,
           Person_ID,
           Trip_Purpose,
           Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(On_campus,
           Trip_Purpose) %>% 
  summarize(segment="W_On_Campus_Trip_rate",
            persons=n(),
            weighted_trips=sum(trips),
            weighted_persons=sum(Weight),
            avg_trips=round(weighted_trips/weighted_persons,digits=2))%>%
  select(On_campus,
         Trip_Purpose, 
         segment, 
         persons, 
         avg_trips)

# weighted trip rates - off campus
W_Off_Campus_TripProductionrates_df<-Trip_subset_df %>%
  filter(On_campus == 0 
         & Trip_Purpose!="99" 
         & !is.na(Trip_Purpose) 
         & !is.na(Weight))%>%
  group_by(On_campus,
           Person_ID,
           Trip_Purpose,
           Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(On_campus,
           Trip_Purpose) %>% 
  summarize(segment="W_Off_Campus_Trip_rate",
            persons=n(),
            weighted_trips=sum(trips),
            weighted_persons=sum(Weight),
            avg_trips=round(weighted_trips/weighted_persons, digits=2))%>%
  select(On_campus,
         Trip_Purpose,
         segment, 
         persons, 
        avg_trips)

Trip_rates_df<-rbind.data.frame(TripProductionrates_base_df, 
                                W_Off_Campus_TripProductionrates_df, 
                                W_On_Campus_TripProductionrates_df)



Trip_rates_df

TotalTrips<-Trip_rates_df%>%group_by(segment,On_campus)%>%summarize(Trips_allpurposes=sum(avg_trips))
TotalTrips
```

Trip production rates by mode show that [discuss, Focus on UOO]

```{r,echo=FALSE}
# trip rates by purpose and by mode  ### wrong
TripProductionrates_bymode_df<-Productions_df %>% 
  group_by(Person_ID,
           Trip_Purpose,
           On_campus,
           Primary_Mode)%>%
  summarize(Total_Trips=sum(Trips))%>%
  group_by(On_campus,
           Trip_Purpose,
           Primary_Mode) %>% 
  summarize(segment=paste0("Trip_Rates_by ",Primary_Mode),
            avg_trips=round(mean(Total_Trips),digits=2), 
            variance=round(var(Total_Trips),digits=2),
            persons=n())%>%
  select(Trip_Purpose,
         segment,
         persons,
         avg_trips
         )

# trip rates by purpose and mode ###LONG

# off_campus by mode trip rates  #add mode dummies to Trip subset

Off_Campus_Car_Trip_rates_df<-Trip_subset_df %>% 
  filter(On_campus ==0 & Car==1 & Trip_Purpose!="99" & !is.na(Trip_Purpose))%>%
  group_by(Person_ID,Trip_Purpose) %>% 
  summarize(trips=n()) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="Off_Campus_Car_Trip_rates",
    persons=n(),
    totaltrips=sum(trips),
    avgtrips=totaltrips/persons) %>%
 select(Trip_Purpose,segment, persons, avgtrips)

W_Off_Campus_Car_Trip_rates_df<-Trip_subset_df %>%
  filter(On_campus ==0 & Car == 1 & Trip_Purpose!="99" & !is.na(Trip_Purpose) & !is.na(Weight))%>%
  group_by(Person_ID,Trip_Purpose,Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="W_Off_Campus_Car_Trip_rate",
    persons=n(),
    weighted_trips=sum(trips),
    weighted_persons=sum(Weight),
    weighted_avgtrips=weighted_trips/weighted_persons)%>%
select(Trip_Purpose, segment, persons, weighted_avgtrips)
 
Off_Campus_Bus_Trip_rates_df<-Trip_subset_df %>% 
  filter(On_campus ==0 & Bus==1 & Trip_Purpose!="99" & !is.na(Trip_Purpose))%>%
  group_by(Person_ID,Trip_Purpose) %>% 
  summarize(trips=n()) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="Off_Campus_Bus_Trip_rates",
    persons=n(),
    totaltrips=sum(trips),
    avgtrips=totaltrips/persons)%>%
select(Trip_Purpose,segment, persons, avgtrips)
 
W_Off_Campus_Bus_Trip_rates_df<-Trip_subset_df %>%
  filter(On_campus ==0 & Bus == 1 & Trip_Purpose!="99" & !is.na(Trip_Purpose) & !is.na(Weight))%>%
  group_by(Person_ID,Trip_Purpose,Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="W_Off_Campus_Bus_Trip_rate",
    persons=n(),
    weighted_trips=sum(trips),
    weighted_persons=sum(Weight),
    weighted_avgtrips=weighted_trips/weighted_persons)%>%
select(Trip_Purpose, segment, persons, weighted_avgtrips)
 
Off_Campus_Bicycle_Trip_rates_df<-Trip_subset_df %>% 
  filter(On_campus ==0 & Bicycle==1 & Trip_Purpose!="99" & !is.na(Trip_Purpose))%>%
  group_by(Person_ID,Trip_Purpose) %>% 
  summarize(trips=n()) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="Off_Campus_Bicycle_Trip_rates",
    persons=n(),
    totaltrips=sum(trips),
    avgtrips=totaltrips/persons)%>%
 select(Trip_Purpose,segment, persons, avgtrips)
 
W_Off_Campus_Bicycle_Trip_rates_df<-Trip_subset_df %>%
  filter(On_campus ==0 & Bicycle == 1 & Trip_Purpose!="99" & !is.na(Trip_Purpose) & !is.na(Weight))%>%
  group_by(Person_ID,Trip_Purpose,Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="W_Off_Campus_Bicycle_Trip_rate",
    persons=n(),
    weighted_trips=sum(trips),
    weighted_persons=sum(Weight),
    weighted_avgtrips=weighted_trips/weighted_persons)%>%
select(Trip_Purpose, segment, persons, weighted_avgtrips)
 
Off_Campus_Walk_Trip_rates_df<-Trip_subset_df %>% 
  filter(On_campus ==0 & Walk==1 & Trip_Purpose!="99" & !is.na(Trip_Purpose))%>%
  group_by(Person_ID,Trip_Purpose) %>% 
  summarize(trips=n()) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="Off_Campus_Walk_Trip_rates",
    persons=n(),
    totaltrips=sum(trips),
    avgtrips=totaltrips/persons) %>%
 select(Trip_Purpose,segment, persons, avgtrips)
 
W_Off_Campus_Walk_Trip_rates_df<-Trip_subset_df %>%
  filter(On_campus ==0 & Walk == 1 & Trip_Purpose!="99" & !is.na(Trip_Purpose) & !is.na(Weight))%>%
  group_by(Person_ID,Trip_Purpose,Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="W_Off_Campus_Walk_Trip_rate",
    persons=n(),
    weighted_trips=sum(trips),
    weighted_persons=sum(Weight),
    weighted_avgtrips=weighted_trips/weighted_persons)%>%
select(Trip_Purpose, segment, persons, weighted_avgtrips)
 
# on_campus by mode trip rates  

On_Campus_Car_Trip_rates_df<-Trip_subset_df %>% 
  filter(On_campus ==1 & Car==1 & Trip_Purpose!="99" & !is.na(Trip_Purpose))%>%
  group_by(Person_ID,Trip_Purpose) %>% 
  summarize(trips=n()) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="On_Campus_Car_Trip_rates",
    persons=n(),
    totaltrips=sum(trips),
    avgtrips=totaltrips/persons) %>%
 select(Trip_Purpose,segment, persons, avgtrips)
 
W_On_Campus_Car_Trip_rates_df<-Trip_subset_df %>%
  filter(On_campus ==1 & Car == 1 & Trip_Purpose!="99" & !is.na(Trip_Purpose) & !is.na(Weight))%>%
  group_by(Person_ID,Trip_Purpose,Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="W_On_Campus_Car_Trip_rate",
    persons=n(),
    weighted_trips=sum(trips),
    weighted_persons=sum(Weight),
    weighted_avgtrips=weighted_trips/weighted_persons)%>%
 select(Trip_Purpose, segment, persons, weighted_avgtrips)
 
On_Campus_Bus_Trip_rates_df<-Trip_subset_df %>% 
  filter(On_campus ==1 & Bus==1 & Trip_Purpose!="99" & !is.na(Trip_Purpose))%>%
  group_by(Person_ID,Trip_Purpose) %>% 
  summarize(trips=n()) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="On_Campus_Bus_Trip_rates",
    persons=n(),
    totaltrips=sum(trips),
    avgtrips=totaltrips/persons)%>%
 select(Trip_Purpose,segment, persons, avgtrips)
 
W_On_Campus_Bus_Trip_rates_df<-Trip_subset_df %>%
  filter(On_campus ==1 & Bus == 1 & Trip_Purpose!="99" & !is.na(Trip_Purpose) & !is.na(Weight))%>%
  group_by(Person_ID,Trip_Purpose,Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="W_On_Campus_Bus_Trip_rate",
    persons=n(),
    weighted_trips=sum(trips),
    weighted_persons=sum(Weight),
    weighted_avgtrips=weighted_trips/weighted_persons)%>%
select(Trip_Purpose, segment, persons, weighted_avgtrips)
 
On_Campus_Bicycle_Trip_rates_df<-Trip_subset_df %>% 
  filter(On_campus ==1 & Bicycle==1 & Trip_Purpose!="99" & !is.na(Trip_Purpose))%>%
  group_by(Person_ID,Trip_Purpose) %>% 
  summarize(trips=n()) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="On_Campus_Bicycle_Trip_rates",
    persons=n(),
    totaltrips=sum(trips),
    avgtrips=totaltrips/persons) %>%
 select(Trip_Purpose,segment, persons, avgtrips)
 
W_On_Campus_Bicycle_Trip_rates_df<-Trip_subset_df %>%
  filter(On_campus ==1 & Bicycle == 1 & Trip_Purpose!="99" & !is.na(Trip_Purpose) & !is.na(Weight))%>%
  group_by(Person_ID,Trip_Purpose,Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="W_On_Campus_Bicycle_Trip_rate",
    persons=n(),
    weighted_trips=sum(trips),
    weighted_persons=sum(Weight),
    weighted_avgtrips=weighted_trips/weighted_persons)%>%
select(Trip_Purpose, segment, persons, weighted_avgtrips)
 
On_Campus_Walk_Trip_rates_df<-Trip_subset_df %>% 
  filter(On_campus ==1 & Walk==1 & Trip_Purpose!="99" & !is.na(Trip_Purpose))%>%
  group_by(Person_ID,Trip_Purpose) %>% 
  summarize(trips=n()) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="On_Campus_Walk_Trip_rates",
    persons=n(),
    totaltrips=sum(trips),
    avgtrips=totaltrips/persons) %>%
 select(Trip_Purpose,segment, persons, avgtrips)
 
W_On_Campus_Walk_Trip_rates_df<-Trip_subset_df %>%
  filter(On_campus ==1 & Walk == 1 & Trip_Purpose!="99" & !is.na(Trip_Purpose) & !is.na(Weight))%>%
  group_by(Person_ID,Trip_Purpose,Weight) %>% 
  summarize(trips=sum(Weight)) %>% 
  group_by(Trip_Purpose) %>% 
  summarize(
    segment="W_On_Campus_Walk_Trip_rate",
    persons=n(),
    weighted_trips=sum(trips),
    weighted_persons=sum(Weight),
    weighted_avgtrips=weighted_trips/weighted_persons)%>%
select(Trip_Purpose, segment, persons, weighted_avgtrips)

Trip_Rates_Off_campus_bymode_df<-rbind.data.frame(
  Off_Campus_Car_Trip_rates_df,
  Off_Campus_Bus_Trip_rates_df,
  Off_Campus_Bicycle_Trip_rates_df,
  Off_Campus_Walk_Trip_rates_df) %>% 
  arrange(Trip_Purpose)

Trip_Rates_Off_campus_bymode_df

Trip_Rates_On_campus_bymode_df<-rbind.data.frame(
  On_Campus_Car_Trip_rates_df,
  On_Campus_Bus_Trip_rates_df,
  On_Campus_Bicycle_Trip_rates_df,
  On_Campus_Walk_Trip_rates_df) %>% 
  arrange(Trip_Purpose)

Trip_Rates_On_campus_df


W_Trip_Rates_Off_campus_bymode_df<-rbind.data.frame(
  W_Off_Campus_Car_Trip_rates_df,
  W_Off_Campus_Bus_Trip_rates_df,
  W_Off_Campus_Bicycle_Trip_rates_df,
  W_Off_Campus_Walk_Trip_rates_df) %>% 
  arrange(Trip_Purpose)

W_Trip_Rates_Off_campus_bymode_df

W_Trip_Rates_On_campus_bymode_df<-rbind.data.frame(
  W_On_Campus_Car_Trip_rates_df,
  W_On_Campus_Bus_Trip_rates_df,
  W_On_Campus_Bicycle_Trip_rates_df,
  W_On_Campus_Walk_Trip_rates_df) %>% 
  arrange(Trip_Purpose)

W_Trip_Rates_On_campus_bymode_df





```


####Regression
As an alternative to the cross-classification method, trip production rates by trip purpose were developed using regression models. The dependent variable is the number of trips per student per day. Potential explanatory variables are place of residence (on-, off- or near campus), graduate or undergrad, full-time or part-time enrollment, employment status and on or off campus employment location. 

A number of models were developed for different trip purpose/residential location combinations and for all data combined, using dummy variables for trip purpose and residential location. Because the trip data are counts and the distribution is skewed, a Poisson regression model was used. A Poisson regression is a generalized linear model used to model count data. In the models presented below, the coefficients are significant and have the expected sign.  Models with compared based on the residual deviance. 
[discuss each of the selected models]
```{r}

# for each model below, checked whether coefficients are significant + whether they have the expected sign
All_P_modela = glm(Trips ~ On_campus + Graduate + UHC + UHO + UCO + UC1, data = Productions_forregression_df, family = poisson, weights = Weight)

summary(All_P_modela)


All_P_modela1 = glm(Trips ~ On_campus + Graduate + Full_time + UHC + UHO + UCO + UC1, data = Productions_forregression_df, family = poisson, weights = Weight)

summary(All_P_modela1)


All_P_modela2 = glm(Trips ~ On_campus + Graduate + Full_time + Job_on + Job_off + UHC + UHO + UCO + UC1  , data = Productions_forregression_df, family = poisson, weights = Weight)

summary(All_P_modela2)

# modelb shows how living near campus is associated with more HC trips DELETE

All_P_modelb = glm(Trips ~ On_campus + Graduate + Full_time + (Distance*UHC*(1-On_campus)) + UHC + UHO + UCO + UC1 , data = Productions_forregression_df, family = poisson, weights = Weight)

summary(All_P_modelb)
```

[identify preferred model]
```{r}
# compare models’ residual deviances (smaller is better)

# compare models to null model. Model a and b have more explanatory power than null model.Chi square statistic shows that difference is significant

All_P_model0 = glm(Trips ~ 1, data = Productions_forregression_df, family = poisson, weights = Weight)
summary(All_P_model0)


All_P_modela1_comparedto0 <- anova(All_P_model0, All_P_modela1, test = "Chisq")
All_P_modela1_comparedto0
All_P_modelb_comparedto0 <- anova(All_P_model0, All_P_modelb, test = "Chisq")
All_P_modelb_comparedto0


# compare larger model (b) to smaller model (a)  - compare models’ residual deviances to determine whether the larger model provides a significant improvement. Model b has more explanatory power - Difference is significant 
All_P_modela1_comparedtob <- anova(All_P_modela, All_P_modelb, test = "Chisq")
All_P_modela1_comparedtob
```
The preferred model was used to develop trip production rates. 

```{r}
# apply models to develop trip rates by trip purpose

print("MODEL A")
#On_campus + Graduate + UHC + UHO + UCO + UC1

All_P_modela_On_UnderGrad_HC<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(1,0,1,0,0,0) ) ),digits=2)
print(paste0(("On_UnderGrad_FT_HC: "), All_P_modela_On_UnderGrad_HC))

All_P_modela_OFF_Grad_HC<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(0,1,1,0,0,0) ) ),digits=2)
print(paste0("Off_Grad_FT_HC: ",All_P_modela_OFF_Grad_HC))

All_P_modela_On_UnderGrad_HO<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(1,0,0,1,0,0) ) ),digits=2)
print(paste0("Off_Grad_FT_HO: ",All_P_modela_On_UnderGrad_HO))

All_P_modela_OFF_Grad_HO<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(0,1,0,1,0,0) ) ),digits=2)
print(paste0("Off_Grad_FT_HO: ",All_P_modela_OFF_Grad_HO))

All_P_modela_ON_UnderGrad_CO<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(1,0,0,0,1,0) ) ),digits=2)
print(paste0("On_Undergrad_FT_CO: ", All_P_modela_ON_UnderGrad_CO))

All_P_modela_OFF_Grad_CO<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(0,1,0,0,1,0) ) ),digits=2)
print(paste0("Off_Grad_FT_CO: ",All_P_modela_OFF_Grad_CO))

All_P_modela_ON_UnderGrad_C1<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(1,0,0,0,0,1) ) ),digits=2)
print(paste0("On_Undergrad_FT_C1: ", All_P_modela_ON_UnderGrad_C1))

All_P_modela_OFF_Grad_CO<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(0,1,0,0,0,1) ) ),digits=2)
print(paste0("Off_Grad_FT_C1: ",All_P_modela_OFF_Grad_CO))

All_P_modela_ON_UnderGrad_OO<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(1,0,0,0,0,0) ) ),digits=2)
print(paste0("On_Undergrad_FT_OO: ", All_P_modela_ON_UnderGrad_OO))

All_P_modela_OFF_Grad_OO<-round(exp( sum( coef(All_P_modela)[ c(1,2,3,4,5,6) ]* c(0,1,0,0,0,0) ) ),digits=2)
print(paste0("Off_Grad_FT_OO: ",All_P_modela_OFF_Grad_OO))

print("MODEL B")

All_P_modelb_On_UnderGrad_HC<-round(exp(sum( coef(All_P_modelb)[ c(1,2,3,4,5,6,7,8)]* c(1,0,1,0,1,0,0,0) ) ),digits=2)
print(paste0("On_UnderGrad_FT_HC: ", All_P_modelb_On_UnderGrad_HC))
All_P_modelb_Off_Grad_HC_Adj<-round(exp( sum( coef(All_P_modelb)[ c(1,2,3,4,5,6,7,8) ]* c(0,1,1,1,1,0,0,0) ) ),digits=2)
print(paste0("Off_Grad_FT_HC_Adj: ",All_P_modelb_Off_Grad_HC_Adj))
All_P_modelb_Off_Grad_HC_NotAdj<-round(exp( sum( coef(All_P_modelb)[ c(1,2,3,4,5,6,7,8) ]* c(0,1,1,0,1,0,0,0) ) ),digits=2)
print(paste0("Off_Grad_FT_HC_NotAdj: ",All_P_modelb_Off_Grad_HC_NotAdj))
All_P_modelb_ON_UnderGrad_CO<-round(exp( sum( coef(All_P_modelb)[ c(1,2,3,4,5,6,7,8) ]* c(1,0,1,0,0,0,1,0) ) ),digits=2)
print(paste0("On_Undergrad_FT_CO: ", All_P_modelb_ON_UnderGrad_CO))
All_P_modelb_OFF_Grad_CO<-round(exp( sum( coef(All_P_modelb)[ c(1,2,3,4,5,6,7,8) ]* c(0,1,1,0,0,1,0,0) ) ),digits=2)
print(paste0("Off_Grad_FT_CO: ",All_P_modelb_OFF_Grad_CO))


# replace with table without ""

 
# then combine with trip rates of model ((a or b) with trip rates developed with cross classification
```
####Conclusion Trip Production

Compare rates based on cross classification based on rates based on regression
Compare to Khattak et al. 
report final rates in table

###TRIP ATTRACTION RATES
As the trip production rates, trip attraction rates for off-campus attractions (UHO, UCO and UOO) were developed based on a survey of NCSU students conducted by the Institute for Transportation Research and Education (ITRE) for the North Carolina Department of Transportation (NCDOT) in 2014. 
For on-campus attractions, the attractions are distributed among campus zones proportional to the distribution of the building square feet. 

Discuss plots
Discuss correlations [fix formula]

```{r}
  
# plot trips against emp - first emp trip plot shows that log transformation is needed

Emp_Trip_pl<-Attractions_byTAZ_df%>% 
  ggplot(aes(TOT_EMP1,Total_W_Trips, color=Trip_Purpose)) + 
  geom_point()
LogEmp_LogTrip_pl<-Attractions_byTAZ_df%>%
  ggplot(aes(log10(TOT_EMP1),log10(Total_W_Trips), color=Trip_Purpose)) + 
  geom_point()
Emp_Trip_pl
LogEmp_LogTrip_pl

HH_Trip_pl<-Attractions_byTAZ_df%>% 
  ggplot(aes(HH,Total_W_Trips, color=Trip_Purpose)) + 
  geom_point()
LogHH_LogTrip_pl<-Attractions_byTAZ_df%>%
  ggplot(aes(log10(HH),log10(Total_W_Trips), color=Trip_Purpose)) + 
  geom_point()
HH_Trip_pl
LogHH_LogTrip_pl

Pop_Trip_pl<-Attractions_byTAZ_df%>% 
  ggplot(aes(TOT_POP1,Total_W_Trips, color=Trip_Purpose)) + 
  geom_point()
LogPop_LogTrip_pl<-Attractions_byTAZ_df%>%
  ggplot(aes(log10(TOT_POP1),log10(Total_W_Trips), color=Trip_Purpose)) + 
  geom_point()
Pop_Trip_pl
LogPop_LogTrip_pl

Retail_Trip_pl<-Attractions_byTAZ_df%>% 
  ggplot(aes(Retail,Total_W_Trips, color=Trip_Purpose)) + 
  geom_point()
LogRetail_LogTrip_pl<-Attractions_byTAZ_df%>%
  ggplot(aes(log10(Retail),log10(Total_W_Trips), color=Trip_Purpose)) + 
  geom_point()
Retail_Trip_pl
LogRetail_LogTrip_pl

Attractions_Summary_df

            #correlations=
             #correlate(Total_W_Trips,
             #           TOT_EMP1,
             #          HH,
              #          TOT_POP1,
             #           Retail))


 



```

```{r}
################################
#check if same as above



TripAttractionrates_base_df<-Attractions_df %>% 
  group_by(TAZ_A,Trip_Purpose, On_campus)%>%
  summarize(Total_W_Trips=sum(Trips_Weighted))%>%
  group_by(On_campus,Trip_Purpose) %>% 
  summarize(mean=mean(Total_W_Trips), variance=var(Total_W_Trips),n=n())
TripAttractionrates_base_df

TripAttractionrates_bymode_df<-Attractions_df %>% 
  group_by(TAZ_A,Trip_Purpose,On_campus,Primary_Mode)%>%
  summarize(Total_W_Trips=sum(Trips_Weighted))%>%
group_by(On_campus,Trip_Purpose,Primary_Mode) %>% 
  summarize(mean=mean(Total_W_Trips), variance=var(Total_W_Trips),n=n())  
TripAttractionrates_bymode_df
```

```{r}
# also try lm with log both sides
 # models fro the following 3 trip purposes: UHO, UCO, and UOO

# interpretation of coefficients.
# response to on_campus ==1 : 1-exp(coeff_on_campus)
# exp(-0.44824) = 0.63875
# 1-exp(-0.44824) = 0.36 # on campus from 0 to 1 --on campus 36 percent fewer trips than campus
# 1/0.63875 = 1.56568 # percent change in response to campus from 1 to 0 -- off campus make 56 percent more trips
#OA_df<-Attractions_byTAZ_df%>% 
#  filter(Trip_Purpose=="UHO"| Trip_Purpose=="UCO"| Trip_Purpose =="UOO")%>%
#  group_by(TAZ_A, On_campus,UHO,UCO)%>%
#  summarize(TotalTripsTAZ=sum(Trips_Weighted),TotalHH=sum(HH),TotalRetail=sum(Retail),TotalEmp=sum(TOT_EMP1),TotalPop=sum(#TOT_POP1),TotalService_RateHigh=sum(Service_RateHigh),Distance=(min(Distance)),TotalNCSU_OFF=sum(NCSU_OFF),TotalService_Ea#rnHigh=sum(Service_EarnHigh), TotalService_EarnLow=sum(Service_EarnLow))


#OLS
OA_modela_lm = lm(Trips_Weighted ~ On_campus, data = Attractions_byTAZ_df)
summary(OA_modela_lm)

OA_modelb_lm = lm(Trips_Weighted ~ On_campus + UHO + UCO,  data = Attractions_byTAZ_df)
summary(OA_modelb_lm)

OA_modelc_lm = lm(Trips_Weighted ~ On_campus + TOT_EMP1 + UHO + UCO, data = Attractions_byTAZ_df)
summary(OA_modelc_lm)

OA_modeld_lm = lm(Trips_Weighted ~ On_campus + Retail + UHO + UCO ,  data = Attractions_byTAZ_df)
summary(OA_modeld_lm)

OA_modele_lm = lm(log10(Trips_Weighted) ~ On_campus + log10(TOT_POP1) + UHO + UCO ,  data = Attractions_byTAZ_df)
summary(OA_modele_lm)

#OA_modelf_lm = lm(log10(Trips_Weighted) ~ On_campus + log10(TOT_EMP1) + UHO + UCO, data = Attractions_byTAZ_df)
summary(OA_modelf_lm)

#OA_modelg_lm = lm(log10(Trips_Weighted) ~ On_campus + log10(Retail) + UHO + UCO ,  data = Attractions_byTAZ_df)
summary(OA_modelg_lm)

#OA_modelh_lm = lm(log10(Trips_Weighted) ~ On_campus + log10(TOT_POP1) + UHO + UCO ,  data = Attractions_byTAZ_df)
summary(OA_modelh_lm)

#Poisson

OA_modelc = glm(Trips_Weighted ~ On_campus + TOT_EMP1 + UHO + UCO, family=poisson, data = Attractions_byTAZ_df)
summary(OA_modelc)

OA_modeld = glm(Trips_Weighted ~ On_campus + Retail + UHO + UCO , family=poisson, data = Attractions_byTAZ_df)
summary(OA_modeld)

OA_modelE = glm(Trips_Weighted~ On_campus + TOT_POP1 + UHO + UCO , family=poisson, data = Attractions_byTAZ_df)
summary(OA_modeld)



# does not work
OA_modelc_on_HO<-round(exp(sum(coef(OA_modelc)[ c(1,2,3,4)]* c(1,1000,1,0) ) ),digits=2)
print(paste0("OA_modelc_on_HO",OA_modelc_on_HO))
OA_modelc_on_CO<-round(exp(sum( coef(OA_modelc)[ c(1,2,3,4)]* c(1,1000,0,1) ) ),digits=2)
print(paste0("OA_modelc_on_CO",OA_modelc_on_CO))
OA_modelc_on_OO<-round(exp(sum( coef(OA_modelc)[ c(1,2,3,4)]* c(1,1000,0,0) ) ),digits=2)
print(paste0("OA_modelc_on_OO",OA_modelc_on_OO))


```
Apply Production Rates

```{r}

# 
# update values
Apply_Productions<-socioecon2_df %>%
  select(TAZ_P,
         StudGQ_NCSU, 
         StudGQ_UNC,
         StudGQ_NCCU,
         StudGQ_DUKE,
         NCSU_OFF,
         UNC_OFF,
         DUKE_OFF,
         NCCU_OFF,
         Share_BuildingsNCSU,
         Share_BuildingsUNC)%>%
  mutate(TR_On_UHC=2, # refer to final trip rate table
         TR_On_UHO=3,
         TR_On_UCO=4,
         TR_On_UOO=1,
         TR_On_UC1=5,
         TR_Off_UHC=2,
         TR_Off_UHO=3,
         TR_Off_UCO=4,
         TR_Off_UOO=1,
         TR_Off_UC1=5,
         On_Campus_NCSU_UHC=StudGQ_NCSU*TR_On_UHC,
         On_Campus_NCSU_UHO=StudGQ_NCSU*TR_On_UHO,
         On_Campus_NCSU_UCO=# based on campus buildings
         On_Campus_NCSU_UOO=# 
         On_Campus_NCSU_UC1=# based on campus buildings
         Off_Campus_NCSU_UHC=NCSU_OFF*TR_Off_UHC) #continue for all segments, all universities

TotalProd<-Socio_with_Productions
summarize(On_Campus_NCSU_UHC # for all segments, all university
          
# add 
#split into campus and off -campus attractions

# on campus attractiosn -- split by buildings
#off campus attractions split by model

          
          
         
         
         
         
         
```

Apply Attraction
```{r}

```


Export files
```{r}
# output files


#write_rds(Productions_df,"Prod.RDS")
#write_rds(Attractions_df,"Attrac.RDS")

#write.csv(NCSU0,"NCSU0.csv",row.names=TRUE)

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
